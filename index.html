<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Forex Position Size Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
    /* Global Styles & Variables */
    :root {
        /* Light Mode Colors */
        --bg-color: #f8f9fa; /* Light background */
        --text-color: #212529; /* Dark text */
        --card-bg: #ffffff; /* White card */
        --input-bg: #f0f2f5; /* Light grey input */
        --label-color: #495057; /* Muted grey label */
        --table-header: linear-gradient(45deg, #007bff, #0056b3); /* Blue gradient header */
        --table-bg: #ffffff; /* White table rows */
        --hover-bg: #e9ecef; /* Light grey hover */
        --result-bg: #e6f7ff; /* Light blue result background */
        --result-text: #007bff; /* Blue result text */
        --button-buy-bg: linear-gradient(45deg, #28a745, #218838); /* Green buy button */
        --button-buy-hover: linear-gradient(45deg, #218838, #28a745);
        --button-sell-bg: linear-gradient(45deg, #dc3545, #c82333); /* Red sell button */
        --button-sell-hover: linear-gradient(45deg, #c82333, #dc3545);
        --toggle-button-bg: #6c757d; /* Grey toggle button */
        --toggle-button-hover: #5a6268;
        --dropdown-bg: #ffffff;
        --dropdown-hover-bg: #f8f9fa;
        --dropdown-text-color: #212529;
        --copy-icon-color: #6c757d;
        --border-color: #dee2e6; /* Light grey border */
        --focus-glow: rgba(0, 123, 255, 0.25); /* Blue glow */
        
        --active-currency-bg: linear-gradient(45deg, #007bff, #0056b3);
        --active-currency-color: white;
    }

    /* Dark Mode Overrides */
    body.dark {
        --bg-color: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460); 
        --text-color: #e0e0e0; 
        --card-bg: #1f2a3c; 
        --input-bg: #2a3b4c; 
        --label-color: #bbd0e0; 
        --table-header: linear-gradient(45deg, #3f51b5, #5c6bc0); 
        --table-bg: #1f2a3c; 
        --hover-bg: #2a3b4c; 
        --result-bg: #2a3b4c; 
        --result-text: #8be0ff; 
        --button-buy-bg: linear-gradient(45deg, #388e3c, #4caf50); 
        --button-buy-hover: linear-gradient(45deg, #4caf50, #388e3c);
        --button-sell-bg: linear-gradient(45deg, #d32f2f, #ef5350); 
        --button-sell-hover: linear-gradient(45deg, #ef5350, #d32f2f);
        --toggle-button-bg: #4a5a6a; 
        --toggle-button-hover: #5c6c7c;
        --dropdown-bg: #2a3b4c;
        --dropdown-hover-bg: #3a4b5c;
        --dropdown-text-color: #e0e0e0;
        --copy-icon-color: #bbd0e0;
        --border-color: #3f51b5; 
        --focus-glow: rgba(139, 224, 255, 0.35); 
        
        --active-currency-bg: linear-gradient(45deg, #3f51b5, #5c6bc0);
        --active-currency-color: white;
    }

    body {
        font-family: 'Poppins', sans-serif;
        background: var(--bg-color);
        padding: 40px;
        color: var(--text-color);
        text-align: center;
        transition: background 0.4s ease, color 0.4s ease;
        margin: 0;
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        direction: ltr; /* Ensure LTR */
        font-size: 17px;
        line-height: 1.6;
    }

    .container {
        background: var(--card-bg);
        max-width: 700px;
        margin: 40px auto;
        padding: 40px 30px;
        border-radius: 20px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        transition: background 0.4s ease, color 0.4s ease, box-shadow 0.4s ease;
        flex-grow: 1;
        border: 1px solid var(--border-color);
    }

    label {
        display: block;
        text-align: left;
        margin: 20px 0 8px;
        font-weight: 600;
        font-size: 16px;
        color: var(--label-color);
    }

    input[type="number"] {
        -moz-appearance: textfield;
        appearance: none;
    }

    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    input[type="number"],
    input[type="text"] {
        width: 100%;
        padding: 14px 18px;
        font-size: 16px;
        border-radius: 12px;
        border: 1.5px solid var(--border-color);
        background: var(--input-bg);
        color: var(--text-color);
        font-weight: 500;
        transition: all 0.3s ease;
        box-sizing: border-box;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        text-align: left;
        box-shadow: inset 0 2px 4px rgba(0,0,0,0.04);
    }

    input[type="number"]::placeholder,
    input[type="text"]::placeholder {
        color: #90a4ae;
        font-style: italic;
        text-align: left;
    }

    body.dark input[type="number"]::placeholder,
    body.dark input[type="text"]::placeholder {
        color: #7b8b9a;
    }

    input[type="number"]:focus,
    input[type="text"]:focus,
    .custom-select:focus {
        border-color: #007bff;
        outline: none;
        box-shadow: 0 0 0 4px var(--focus-glow);
    }

    body.dark input[type="number"]:focus,
    body.dark input[type="text"]:focus {
        border-color: #8be0ff;
    }

    /* Styles for Selection Buttons (Currency & Risk) */
    .currency-selection,
    .risk-selection { 
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
    }

    .currency-selection button,
    .risk-selection button {
        flex: 1;
        padding: 14px 18px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 12px;
        border: 1.5px solid var(--border-color);
        background: var(--input-bg);
        color: var(--label-color);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .currency-selection button:hover,
    .risk-selection button:hover {
        background-color: var(--hover-bg);
    }

    .currency-selection button.active,
    .risk-selection button.active {
        background: var(--active-currency-bg);
        color: var(--active-currency-color);
        border-color: transparent;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    /* Button Group */
    .button-group {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        direction: ltr; /* Ensure LTR */
    }

    button {
        flex: 1;
        border: none;
        color: white;
        padding: 15px 25px;
        font-size: 17px;
        font-weight: 600;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        font-family: 'Poppins', sans-serif;
        letter-spacing: 0.5px;
    }

    button.buy {
        background: var(--button-buy-bg);
    }

    button.buy:hover {
        background: var(--button-buy-hover);
        transform: translateY(-3px);
        box-shadow: 0 12px 25px rgba(0,0,0,0.2);
    }

    button.sell {
        background: var(--button-sell-bg);
    }

    button.sell:hover {
        background: var(--button-sell-hover);
        transform: translateY(-3px);
        box-shadow: 0 12px 25px rgba(0,0,0,0.2);
    }

    /* Result Section */
    .result {
        margin-top: 40px;
        background: var(--result-bg);
        padding: 30px 25px;
        border-radius: 18px;
        font-size: 18px;
        color: var(--result-text);
        font-weight: 600;
        box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        transition: background 0.4s ease, color 0.4s ease, box-shadow 0.4s ease;
        text-align: left;
        min-height: 250px;
        display: flex;
        align-items: flex-start;
        justify-content: flex-start;
        flex-direction: column;
        border: 1px solid rgba(0,0,0,0.05);
    }

    .result span {
        font-family: 'Poppins', sans-serif;
    }

    table {
        width: 100%;
        max-width: 100%;
        margin: 20px auto;
        border-collapse: separate;
        border-spacing: 0 10px;
        font-weight: 500;
        font-size: 16px;
        text-align: left;
        transition: background 0.4s ease, color 0.4s ease;
    }

    th, td {
        padding: 15px 20px;
        border-radius: 10px;
        background: var(--table-bg);
        color: var(--text-color);
        transition: background 0.4s ease, color 0.4s ease, background-color 0.3s ease;
        text-align: left;
        font-family: 'Poppins', sans-serif;
        border: 1px solid var(--border-color);
    }

    th {
        background: var(--table-header);
        color: white;
        text-align: left;
        border: none;
        font-weight: 600;
    }

    table tr:first-child th:first-child { border-top-left-radius: 10px; }
    table tr:first-child th:last-child { border-top-right-radius: 10px; }
    table tr:last-child td:first-child { border-bottom-left-radius: 10px; }
    table tr:last-child td:last-child { border-bottom-right-radius: 10px; }

    tr:hover td {
        background-color: var(--hover-bg);
    }

    /* Fixed Settings Button (Dark Mode Toggle - Omitted for brevity) */

    /* Copy Icon */
    .copy-icon {
        cursor: pointer;
        margin-left: 10px;
        width: 18px;
        height: 18px;
        vertical-align: middle;
        fill: var(--copy-icon-color);
        transition: fill 0.3s ease;
    }

    .copy-icon:hover {
        fill: #007bff;
    }
    
    /* New styles for Profit and Loss colors */
    .profit-row td {
        color: #28a745; /* Green color for profit */
    }
    
    .loss-row td {
        color: #dc3545; /* Red color for loss */
    }

    /* New styles for input labels */
    .loss-label {
        color: #dc3545; /* Red color for Stop Loss label */
    }

    .profit-label {
        color: #28a745; /* Green color for Take Profit label */
    }
</style>
</head>
<body>
    <div class="container" id="mainCalculatorContainer">
        <section id="forexCalculator">
            <div class="input-group">
                <label>Currency Pair</label>
                <div class="currency-selection">
                    <button id="btnUSDCAD" class="currency-button active" onclick="selectCurrency('USDCAD')">USDCAD</button>
                    <button id="btnUSDJPY" class="currency-button" onclick="selectCurrency('USDJPY')">USDJPY</button>
                </div>
            </div>
            
            <input type="hidden" id="currencyPair" value="USDCAD">

            <div class="input-group">
                <label for="forexAccountSize">Account Size ($)</label>
                <input type="number" id="forexAccountSize" min="0.01" step="0.01">
            </div>

            <div class="input-group">
                <label>Risk Percentage</label>
                <div class="risk-selection">
                    <button id="btnRisk1" class="risk-button active" onclick="selectRisk(1)">1%</button>
                    <button id="btnRisk05" class="risk-button" onclick="selectRisk(0.5)">0.5%</button>
                </div>
            </div>
            <input type="hidden" id="forexRiskPercent" value="1"> 
            
            <div class="input-group">
                <label for="forexEntryPrice">Entry Price</label>
                <input type="number" id="forexEntryPrice" min="0.00000001" step="0.00000001">
            </div>
            <div class="input-group">
                <label for="forexTpPips" id="takeProfitLabel" class="profit-label">TP (Pips)</label>
                <input type="number" id="forexTpPips" min="0.1" step="0.1">
            </div>
            <div class="input-group">
                <label for="forexStopPips" id="stopLossLabel" class="loss-label">SL (Pips)</label>
                <input type="number" id="forexStopPips" min="0.1" step="0.1">
            </div>
            <div class="button-group">
                <button class="sell" onclick="calculateForex('short')">Sell</button>
                <button class="buy" onclick="calculateForex('long')">Buy</button>
            </div>
        </section>
        <div id="output" class="result" style="display: none;">
        </div>
    </div>
    
    <script>
        // --- Utility Functions ---
        function getRandomInRange(min, max, decimals = 2) {
            const factor = Math.pow(10, decimals);
            return Math.round((Math.random() * (max - min) + min) * factor) / factor;
        }

        function copyValue(event, value) {
            event.stopPropagation();
            navigator.clipboard.writeText(value).then(() => {
                const iconElement = event.currentTarget;
                const originalInnerHTML = iconElement.innerHTML;
                const originalFill = iconElement.style.fill;
                iconElement.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20px" height="20px"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z"/></svg>'; /* Checkmark SVG */
                iconElement.style.fill = '#28a745'; 
                setTimeout(() => {
                    iconElement.innerHTML = originalInnerHTML;
                    iconElement.style.fill = originalFill;
                }, 1500);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }

        // --- Currency Selection Logic (تثبیت‌شده) ---
        function selectCurrency(pair) {
            // حذف کلاس active از تمام دکمه‌های جفت ارز
            const buttons = document.querySelectorAll('.currency-button');
            buttons.forEach(button => button.classList.remove('active'));
            
            // افزودن کلاس active به دکمه فعلی
            const targetButton = document.getElementById(`btn${pair}`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            // به‌روزرسانی مقدار پنهان
            document.getElementById('currencyPair').value = pair;
            updateInputLabels(pair);
        }

        // --- Risk Selection Logic (تثبیت‌شده) ---
        function selectRisk(percent) {
            // حذف کلاس active از تمام دکمه‌های ریسک
            const buttons = document.querySelectorAll('.risk-button');
            buttons.forEach(button => button.classList.remove('active'));
            
            const idSuffix = (percent === 1) ? '1' : '05'; 
            
            // افزودن کلاس active به دکمه فعلی
            const targetButton = document.getElementById(`btnRisk${idSuffix}`);
            if (targetButton) {
                targetButton.classList.add('active');
            }
            // به‌روزرسانی مقدار پنهان
            document.getElementById('forexRiskPercent').value = percent;
        }

        // --- Main Calculation Logic (با قابلیت تولید رندوم) ---
        function calculateForex(tradeType) {
            document.getElementById("output").style.display = "flex";

            // --- 1. Get Values ---
            let accountSize = parseFloat(document.getElementById('forexAccountSize').value);
            let riskPercent = parseFloat(document.getElementById('forexRiskPercent').value); 
            let currencyPair = document.getElementById('currencyPair').value;
            let entryPrice = parseFloat(document.getElementById('forexEntryPrice').value);
            let inputStopLossValue = parseFloat(document.getElementById('forexStopPips').value);
            let inputTakeProfitValue = parseFloat(document.getElementById('forexTpPips').value);

            // --- 2. Random/Default Generation for Empty Fields (رفع مشکل کار نکردن بدون ورودی) ---
            if (isNaN(accountSize) || accountSize <= 0) {
                accountSize = getRandomInRange(5000, 20000, 2); 
                document.getElementById('forexAccountSize').value = accountSize.toFixed(2); 
            }

            if (isNaN(entryPrice) || entryPrice <= 0) {
                const priceRanges = {
                    'USDCAD': [1.30000, 1.35000, 5], 
                    'USDJPY': [150.000, 160.000, 3], 
                };
                const [min, max, decimals] = priceRanges[currencyPair] || [1.00000, 1.50000, 5];
                entryPrice = getRandomInRange(min, max, decimals);
                document.getElementById('forexEntryPrice').value = entryPrice.toFixed(decimals); 
            }
            
            if (isNaN(inputStopLossValue) || inputStopLossValue <= 0) {
                inputStopLossValue = getRandomInRange(15, 60, 1); 
                document.getElementById('forexStopPips').value = inputStopLossValue.toFixed(1); 
            }
            
            if (isNaN(inputTakeProfitValue) || inputTakeProfitValue <= 0) {
                inputTakeProfitValue = getRandomInRange(70, 200, 1); 
                document.getElementById('forexTpPips').value = inputTakeProfitValue.toFixed(1); 
            }
            
            // --- 3. Calculation Logic ---
            const riskAmount = accountSize * (riskPercent / 100);

            let pricePrecision;
            let stopLossPriceChangeInPriceUnits;
            let takeProfitPriceChangeInPriceUnits;

            const pairConfigs = {
                'USDCAD': { 'pipSize': 0.0001, 'pricePrecision': 5 }, 
                'USDJPY': { 'pipSize': 0.01, 'pricePrecision': 3 },
            };

            const config = pairConfigs[currencyPair];

            if (!config) {
                document.getElementById("output").innerHTML = `<p style="color: #e05e5e;">Selected currency pair (${currencyPair}) is not supported.</p>`;
                return;
            }

            pricePrecision = config.pricePrecision;

            stopLossPriceChangeInPriceUnits = inputStopLossValue * config.pipSize;
            takeProfitPriceChangeInPriceUnits = inputTakeProfitValue * config.pipSize;
            
            const displayStopLossPrice = (tradeType === 'long') ? entryPrice - stopLossPriceChangeInPriceUnits : entryPrice + stopLossPriceChangeInPriceUnits;
            const displayTakeProfitPrice = (tradeType === 'long') ? entryPrice + takeProfitPriceChangeInPriceUnits : entryPrice - takeProfitPriceChangeInPriceUnits;

            // --- Validation Logic ---
            if (tradeType === 'long') {
                if (displayStopLossPrice >= entryPrice || displayTakeProfitPrice <= entryPrice) {
                    document.getElementById("output").innerHTML = `<p style="color: #e05e5e;">For a **Buy (Long)** position, Stop Loss must be **LOWER** and Take Profit must be **HIGHER** than the Entry Price. Adjust Pips.</p>`;
                    return;
                }
            } else { // Short position
                if (displayStopLossPrice <= entryPrice || displayTakeProfitPrice >= entryPrice) {
                    document.getElementById("output").innerHTML = `<p style="color: #e05e5e;">For a **Sell (Short)** position, Stop Loss must be **HIGHER** and Take Profit must be **LOWER** than the Entry Price. Adjust Pips.</p>`;
                    return;
                }
            }
            
            // --- Position Size Calculation Logic ---
            const quoteCurrency = currencyPair.substring(3);
            const standardLotSize = 100000;
            
            let valuePerPipOrPointPerLot; 
            
            if (quoteCurrency === 'USD') {
                valuePerPipOrPointPerLot = standardLotSize * config.pipSize; 
            } else if (['JPY', 'CAD'].includes(quoteCurrency)) { 
                valuePerPipOrPointPerLot = (standardLotSize * config.pipSize) / entryPrice;
            } else {
                document.getElementById("output").innerHTML = `<p style="color: #e05e5e;">Calculation for cross-currency pair ${currencyPair} is not fully supported.</p>`;
                return;
            }

            const effectiveStopLossDistance = inputStopLossValue;
            const totalDollarR
